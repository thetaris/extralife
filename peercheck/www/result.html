<html>

<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="../style/style.css"/>
<link rel="stylesheet" type="text/css" href="../style/jquery.mobile-1.4.2.min.css"/>
<script type="text/javascript" src="../style/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../style/jquery.mobile-1.4.2.min.js"></script>
<%
    userid <- req$cookies()$userid
    if (is.null(userid)) {
      userid <- paste(sample(c(0:9, letters, LETTERS), 20, replace=TRUE), collapse="")
      res$set_cookie(key="userid", value=userid)
    }
    questionid <- req$GET()$questionid
    
    # comes from startup.html
    lebenszufriedenD1 <<- req$POST()$lebenszufriedenD1
    lebenszufriedenD2 <<- req$POST()$lebenszufriedenD2
    lebenszufriedenD3 <<- req$POST()$lebenszufriedenD3
    lebenszufriedenD4 <<- req$POST()$lebenszufriedenD4
    lebenszufriedenD5 <<- req$POST()$lebenszufriedenD5
    
    if (!is.null(lebenszufriedenD1)){
      saveQuestion(userid, "lebenszufriedenD1", lebenszufriedenD1)
      saveQuestion(userid, "lebenszufriedenD2", lebenszufriedenD2)
      saveQuestion(userid, "lebenszufriedenD3", lebenszufriedenD3)
      saveQuestion(userid, "lebenszufriedenD4", lebenszufriedenD4)
      saveQuestion(userid, "lebenszufriedenD5", lebenszufriedenD5)
    }else{
    if (!is.null(questionid) && nchar(questionid) > 0) {
      value = req$POST()$answer
      if (!is.null(value))
        saveQuestion(userid, questionid, value)
    }
    }
    nextq <- nextQuestion(userid)
%>
<body>
  <h1>Anleitung zum Glücklichsein</h1>
  <%=
   {
   score <- getSatisfaction(userid)
   if ((!is.null(lebenszufriedenD1))&&(length(score)>0)){
        allScores <- sapply(getUsers(), function(userid) return(getSatisfaction(userid)))
        allScoresTxt <<- sapply(getUsers(), function(userid) return(getSatisfactionText(getSatisfaction(userid))))
        
        txt <- tags$div(
        tags$h2("Auswertung"),
        sprintf("Du bist %s. (%i von 100 Punkten)",  getSatisfactionText(score), getSatisfactionPct(score)),
        tags$div(style="text-align:center",
          getEmoticonHTML(getSatisfactionPct(score)/100, size=150)),
        tags$h2("Übersicht über die Antworten"),
        
        tags$table(width="100%",
          tags$tr(tags$td(), tags$td("Zufriedenheit"), tags$td("# Personen")),
          lapply(6:1, function(iterS) {
            sTxt <- getSatisfactionText(iterS*5)[[1]]
            tags$tr(
               tags$td(getEmoticonHTML((iterS-1)/5, size=30)),
               tags$td(sTxt),
               tags$td(sum(unlist(allScoresTxt)==sTxt))
            )
          }))
        )
  } else {
    txt <- c(sprintf('So glücklich sind die Antwortenden von "%s"', 
      ELQuestions[[questionid]]$Text), 
      getSatisfactionHTML(questionid))
  }
  as.character(txt)
  }  
  %>
  <h2>
    Finde heraus, was glücklich macht.
  </h2>
  <p>
    <form method="GET" action="http:question.html">
      <div style="display:none">
	      <input name="questionid" value="<%= nextq[[1]] %>">
      </div>
      <button type="submit"><%= ELQuestions[[nextq[[1]]]]$shortText %></button>
    </form>
    <form method="GET" action="http:question.html">
      <div style="display:none">
	      <input name="questionid" value="<%= nextq[[2]] %>">
      </div>
      <button type="submit"><%= ELQuestions[[nextq[[2]]]]$shortText %></button>
    </form>
    <form method="GET" action="http:question.html">
      <div style="display:none">
	      <input name="questionid" value="<%= nextq[[3]] %>">
      </div>
      <button type="submit"><%= ELQuestions[[nextq[[3]]]]$shortText %></button>
    </form>
  </p>
</body>
</html>
